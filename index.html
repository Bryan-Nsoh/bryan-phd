<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DSE PhD Tracker</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --bg: #0a0a0a;
      --card: #1a1a1a;
      --border: #333;
      --text: #fff;
      --muted: #888;
      --accent: #38bdf8;
      --green: #22c55e;
      --yellow: #eab308;
      --red: #ef4444;
      --purple: #a855f7;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      padding: 1rem;
    }
    .container { max-width: 900px; margin: 0 auto; }

    /* Tabs */
    .tabs {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1.5rem;
      border-bottom: 1px solid var(--border);
      padding-bottom: 0.5rem;
    }
    .tab {
      background: none;
      border: none;
      color: var(--muted);
      padding: 0.75rem 1.25rem;
      cursor: pointer;
      font-size: 0.9rem;
      border-radius: 8px 8px 0 0;
      transition: all 0.2s;
    }
    .tab:hover { color: var(--text); background: var(--card); }
    .tab.active { color: var(--accent); background: var(--card); font-weight: 600; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }

    /* Header */
    header {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
    }
    header h1 { font-size: 1.25rem; color: var(--accent); margin-bottom: 0.25rem; }
    header p { color: var(--muted); font-size: 0.85rem; }
    .progress-bar { height: 8px; background: var(--border); border-radius: 4px; margin: 1rem 0 0.5rem; overflow: hidden; }
    .progress-fill { height: 100%; background: linear-gradient(90deg, var(--accent), var(--green)); transition: width 0.5s; }
    .quick-stats { display: flex; gap: 1.5rem; margin-top: 1rem; flex-wrap: wrap; }
    .quick-stat-value { font-size: 1.5rem; font-weight: 700; color: var(--accent); }
    .quick-stat-label { font-size: 0.7rem; color: var(--muted); text-transform: uppercase; }

    /* Cards */
    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 1rem;
      margin-bottom: 1rem;
    }
    .card h2 {
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--muted);
      margin-bottom: 0.75rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .card h2 button {
      background: var(--accent);
      color: var(--bg);
      border: none;
      width: 22px;
      height: 22px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 1rem;
    }

    /* Course Categories */
    .category {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 8px;
      margin-bottom: 1rem;
      overflow: hidden;
    }
    .category-header {
      background: #222;
      padding: 0.75rem 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      user-select: none;
    }
    .category-header:hover { background: #2a2a2a; }
    .category-title { font-weight: 600; display: flex; align-items: center; gap: 0.5rem; }
    .category-title .arrow { transition: transform 0.2s; }
    .category.collapsed .arrow { transform: rotate(-90deg); }
    .category.collapsed .category-courses { display: none; }
    .category-credits { font-size: 0.8rem; color: var(--muted); }
    .category-courses { padding: 0.5rem; }

    /* Course Items */
    .course-row {
      display: flex;
      align-items: center;
      padding: 0.6rem 0.5rem;
      margin-bottom: 0.25rem;
      border-radius: 6px;
      background: var(--bg);
      border: 1px solid var(--border);
      gap: 0.75rem;
    }
    .course-row input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
      accent-color: var(--green);
    }
    .course-row.completed { opacity: 0.5; }
    .course-row.completed .course-title { text-decoration: line-through; }
    .course-title { flex: 1; font-size: 0.9rem; }
    .course-meta { display: flex; align-items: center; gap: 0.5rem; }
    .badge {
      font-size: 0.7rem;
      padding: 0.2rem 0.5rem;
      border-radius: 4px;
      font-weight: 500;
    }
    .badge.in-progress { background: #3a3a00; color: var(--yellow); }
    .badge.transfer { background: #2a0a3a; color: var(--purple); }
    .badge.planned { background: #1a2a3a; color: var(--accent); }
    .credits { color: var(--green); font-weight: 600; font-size: 0.85rem; }

    /* Grid layouts */
    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1rem; margin-bottom: 1rem; }

    /* Deadlines */
    .deadline-item {
      display: flex;
      align-items: center;
      padding: 0.6rem 0;
      border-bottom: 1px solid var(--border);
      gap: 0.75rem;
    }
    .deadline-item:last-child { border-bottom: none; }
    .urgency { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
    .urgency.red { background: var(--red); box-shadow: 0 0 6px var(--red); }
    .urgency.yellow { background: var(--yellow); }
    .urgency.green { background: var(--green); }
    .deadline-info { flex: 1; }
    .deadline-name { font-weight: 500; font-size: 0.9rem; }
    .deadline-date { font-size: 0.75rem; color: var(--muted); }
    .deadline-remaining { font-size: 0.85rem; font-weight: 600; }

    /* Milestones */
    .milestone-item {
      display: flex;
      align-items: center;
      padding: 0.6rem 0;
      border-bottom: 1px solid var(--border);
      gap: 0.75rem;
      cursor: pointer;
    }
    .milestone-item:last-child { border-bottom: none; }
    .milestone-check {
      width: 20px;
      height: 20px;
      border: 2px solid var(--border);
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.8rem;
    }
    .milestone-check.done { background: var(--green); border-color: var(--green); color: var(--bg); }

    /* Summary Box */
    .summary {
      background: var(--card);
      border: 2px solid var(--green);
      border-radius: 8px;
      padding: 1rem;
      margin-top: 1rem;
    }
    .summary h3 { color: var(--green); font-size: 0.9rem; margin-bottom: 0.75rem; }
    .summary-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 0.5rem; font-size: 0.85rem; }
    .summary-stat { display: flex; justify-content: space-between; padding: 0.25rem 0; }
    .summary-stat span:last-child { font-weight: 600; color: var(--green); }

    /* Delete buttons */
    .delete-btn {
      background: none;
      border: none;
      color: var(--muted);
      cursor: pointer;
      opacity: 0;
      transition: opacity 0.2s;
      font-size: 1.1rem;
    }
    .course-row:hover .delete-btn,
    .deadline-item:hover .delete-btn,
    .milestone-item:hover .delete-btn { opacity: 1; }
    .delete-btn:hover { color: var(--red); }

    /* Modal */
    .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); align-items: center; justify-content: center; z-index: 100; }
    .modal.active { display: flex; }
    .modal-content { background: var(--card); padding: 1.5rem; border-radius: 12px; width: 90%; max-width: 400px; border: 1px solid var(--border); }
    .modal h3 { margin-bottom: 1rem; color: var(--accent); font-size: 1rem; }
    .form-group { margin-bottom: 0.75rem; }
    .form-group label { display: block; margin-bottom: 0.25rem; font-size: 0.8rem; color: var(--muted); }
    .form-group input, .form-group select {
      width: 100%;
      padding: 0.6rem;
      border: 1px solid var(--border);
      border-radius: 6px;
      background: var(--bg);
      color: var(--text);
      font-size: 0.9rem;
    }
    .form-group input:focus, .form-group select:focus { outline: none; border-color: var(--accent); }
    .form-group small { display: block; margin-top: 0.25rem; color: var(--muted); font-size: 0.7rem; }
    .form-group small a { color: var(--accent); }
    .modal-buttons { display: flex; gap: 0.5rem; margin-top: 1rem; }
    .modal-buttons button { flex: 1; padding: 0.6rem; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9rem; }
    .btn-cancel { background: var(--border); color: var(--text); }
    .btn-save { background: var(--accent); color: var(--bg); font-weight: 600; }

    /* Footer */
    footer { text-align: center; padding: 1.5rem; color: var(--muted); font-size: 0.75rem; }
    footer button { background: none; border: 1px solid var(--border); color: var(--muted); padding: 0.4rem 0.75rem; border-radius: 4px; cursor: pointer; margin: 0 0.2rem; font-size: 0.75rem; }
    footer button:hover { border-color: var(--accent); color: var(--accent); }
    .sync-status { display: inline-flex; align-items: center; gap: 0.4rem; margin-bottom: 0.5rem; }
    .sync-dot { width: 6px; height: 6px; border-radius: 50%; background: var(--muted); }
    .sync-dot.connected { background: var(--green); }
    .sync-dot.syncing { background: var(--yellow); animation: pulse 1s infinite; }
    .sync-dot.error { background: var(--red); }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>DSE PhD TRACKER</h1>
      <p id="program-info">Data Science & Engineering • Bredesen Center</p>
      <div class="progress-bar"><div class="progress-fill" id="timeline-bar" style="width: 0%"></div></div>
      <div style="display: flex; justify-content: space-between; font-size: 0.75rem; color: var(--muted);">
        <span>Started: Fall 2025</span>
        <span id="timeline-text">0%</span>
        <span>Target: Spring 2029</span>
      </div>
      <div class="quick-stats">
        <div><div class="quick-stat-value" id="credits-stat">0/36</div><div class="quick-stat-label">Credits</div></div>
        <div><div class="quick-stat-value" id="transferred-stat">6</div><div class="quick-stat-label">Transferred</div></div>
        <div><div class="quick-stat-value" id="in-progress-stat">0</div><div class="quick-stat-label">In Progress</div></div>
        <div><div class="quick-stat-value" id="remaining-stat">0</div><div class="quick-stat-label">Remaining</div></div>
        <div><div class="quick-stat-value" id="next-deadline-stat">--</div><div class="quick-stat-label">Days to Next</div></div>
      </div>
    </header>

    <div class="tabs">
      <button class="tab active" onclick="showTab('overview')">Overview</button>
      <button class="tab" onclick="showTab('courses')">Courses</button>
      <button class="tab" onclick="showTab('deadlines')">Deadlines</button>
      <button class="tab" onclick="showTab('milestones')">Milestones</button>
    </div>

    <!-- OVERVIEW TAB -->
    <div class="tab-content active" id="tab-overview">
      <div class="grid">
        <div class="card">
          <h2>Current Semester</h2>
          <div id="current-courses"></div>
        </div>
        <div class="card">
          <h2>Upcoming Deadlines</h2>
          <div id="upcoming-deadlines"></div>
        </div>
      </div>
      <div class="card">
        <h2>Milestones</h2>
        <div id="overview-milestones"></div>
      </div>
      <div class="summary">
        <h3>CREDIT BREAKDOWN</h3>
        <div class="summary-stats">
          <div class="summary-stat"><span>Total Required</span><span>36</span></div>
          <div class="summary-stat"><span>Transferred</span><span id="sum-transferred">6</span></div>
          <div class="summary-stat"><span>Completed</span><span id="sum-completed">0</span></div>
          <div class="summary-stat"><span>In Progress</span><span id="sum-inprogress">0</span></div>
          <div class="summary-stat"><span>Remaining</span><span id="sum-remaining">0</span></div>
        </div>
      </div>
    </div>

    <!-- COURSES TAB -->
    <div class="tab-content" id="tab-courses">
      <div id="course-categories"></div>
      <button class="btn-save" style="width: 100%; margin-top: 1rem;" onclick="openModal('course')">+ Add Course</button>
    </div>

    <!-- DEADLINES TAB -->
    <div class="tab-content" id="tab-deadlines">
      <div class="card">
        <h2>All Deadlines <button onclick="openModal('deadline')">+</button></h2>
        <div id="all-deadlines"></div>
      </div>
    </div>

    <!-- MILESTONES TAB -->
    <div class="tab-content" id="tab-milestones">
      <div class="card">
        <h2>All Milestones <button onclick="openModal('milestone')">+</button></h2>
        <div id="all-milestones"></div>
      </div>
    </div>

    <footer>
      <div class="sync-status">
        <div class="sync-dot" id="sync-dot"></div>
        <span id="sync-text">Local only</span>
      </div>
      <p></p>
      <button onclick="openModal('github')">GitHub Sync</button>
      <button onclick="exportData()">Export</button>
      <button onclick="document.getElementById('import-file').click()">Import</button>
      <button onclick="openModal('settings')">Settings</button>
      <input type="file" id="import-file" accept=".json" style="display:none" onchange="importData(event)">
    </footer>
  </div>

  <!-- MODALS -->
  <div class="modal" id="modal-course">
    <div class="modal-content">
      <h3>Add Course</h3>
      <div class="form-group">
        <label>Course Name</label>
        <input type="text" id="course-name" placeholder="e.g., DSE 512 - Data Sci II">
      </div>
      <div class="form-group">
        <label>Category</label>
        <select id="course-category">
          <option value="core">Core Requirements</option>
          <option value="domain">ML/Domain</option>
          <option value="breadth">Knowledge Breadth</option>
          <option value="600level">600-Level</option>
          <option value="seminar">Seminar</option>
        </select>
      </div>
      <div class="form-group">
        <label>Credits</label>
        <input type="number" id="course-credits" value="3" min="1" max="6">
      </div>
      <div class="form-group">
        <label>Status</label>
        <select id="course-status">
          <option value="planned">Planned</option>
          <option value="in-progress">In Progress</option>
          <option value="completed">Completed</option>
          <option value="transfer">Transfer Credit</option>
        </select>
      </div>
      <div class="form-group">
        <label>Semester (optional)</label>
        <input type="text" id="course-semester" placeholder="e.g., Fall 2025">
      </div>
      <div class="modal-buttons">
        <button class="btn-cancel" onclick="closeModal('course')">Cancel</button>
        <button class="btn-save" onclick="saveCourse()">Add</button>
      </div>
    </div>
  </div>

  <div class="modal" id="modal-deadline">
    <div class="modal-content">
      <h3>Add Deadline</h3>
      <div class="form-group">
        <label>Name</label>
        <input type="text" id="deadline-name" placeholder="e.g., Qualifying Exam">
      </div>
      <div class="form-group">
        <label>Date</label>
        <input type="date" id="deadline-date">
      </div>
      <div class="modal-buttons">
        <button class="btn-cancel" onclick="closeModal('deadline')">Cancel</button>
        <button class="btn-save" onclick="saveDeadline()">Add</button>
      </div>
    </div>
  </div>

  <div class="modal" id="modal-milestone">
    <div class="modal-content">
      <h3>Add Milestone</h3>
      <div class="form-group">
        <label>Name</label>
        <input type="text" id="milestone-name" placeholder="e.g., Proposal Defense">
      </div>
      <div class="modal-buttons">
        <button class="btn-cancel" onclick="closeModal('milestone')">Cancel</button>
        <button class="btn-save" onclick="saveMilestone()">Add</button>
      </div>
    </div>
  </div>

  <div class="modal" id="modal-settings">
    <div class="modal-content">
      <h3>Settings</h3>
      <div class="form-group">
        <label>Start Date</label>
        <input type="date" id="settings-start">
      </div>
      <div class="form-group">
        <label>Expected Graduation</label>
        <input type="date" id="settings-end">
      </div>
      <div class="form-group">
        <label>Total Credits Required</label>
        <input type="number" id="settings-credits" value="36">
      </div>
      <div class="modal-buttons">
        <button class="btn-cancel" onclick="closeModal('settings')">Cancel</button>
        <button class="btn-save" onclick="saveSettings()">Save</button>
      </div>
    </div>
  </div>

  <div class="modal" id="modal-github">
    <div class="modal-content">
      <h3>GitHub Sync</h3>
      <div class="form-group">
        <label>GitHub Username</label>
        <input type="text" id="gh-username" placeholder="e.g., Bryan-Nsoh">
      </div>
      <div class="form-group">
        <label>Repository Name</label>
        <input type="text" id="gh-repo" placeholder="e.g., bryan-phd">
      </div>
      <div class="form-group">
        <label>Personal Access Token</label>
        <input type="password" id="gh-token" placeholder="ghp_xxxx">
        <small><a href="https://github.com/settings/tokens/new?scopes=repo&description=PhD%20Tracker" target="_blank">Create token</a> (repo scope)</small>
      </div>
      <div class="modal-buttons">
        <button class="btn-cancel" onclick="closeModal('github')">Cancel</button>
        <button class="btn-cancel" onclick="disconnectGitHub()" id="gh-disconnect" style="display:none">Disconnect</button>
        <button class="btn-save" onclick="connectGitHub()">Connect</button>
      </div>
    </div>
  </div>

  <script>
    const defaultData = {
      settings: {
        startDate: "2025-08-01",
        endDate: "2029-05-15",
        creditsRequired: 36
      },
      courseCategories: [
        { id: "core", name: "Core Requirements", requiredCredits: 21 },
        { id: "domain", name: "ML/Domain", requiredCredits: 9 },
        { id: "breadth", name: "Knowledge Breadth", requiredCredits: 6 },
        { id: "600level", name: "600-Level Requirement", requiredCredits: 6 },
        { id: "seminar", name: "Seminar", requiredCredits: 3 }
      ],
      courses: [
        // Core - 21 credits total
        { name: "DSE 511: Data Sci & Computing I", category: "core", credits: 3, status: "in-progress", semester: "Fall 2025" },
        { name: "DSE 512: Data Sci & Computing II", category: "core", credits: 3, status: "planned", semester: "" },
        { name: "Data Analysis (CSCE 878)", category: "core", credits: 3, status: "transfer", semester: "Transfer" },
        { name: "Statistics I (STAT 563)", category: "core", credits: 3, status: "in-progress", semester: "Fall 2025" },
        { name: "Statistics II", category: "core", credits: 3, status: "planned", semester: "" },
        { name: "Math/Numerical (STAT 801A)", category: "core", credits: 3, status: "transfer", semester: "Transfer" },
        { name: "Adv Topics Data Mining (600-level)", category: "core", credits: 3, status: "planned", semester: "" },
        // ML/Domain - 9 credits
        { name: "COSC 524: NLP", category: "domain", credits: 3, status: "in-progress", semester: "Fall 2025" },
        { name: "Domain Course 1", category: "domain", credits: 3, status: "planned", semester: "" },
        { name: "Domain Course 2", category: "domain", credits: 3, status: "planned", semester: "" },
        // Knowledge Breadth - 6 credits
        { name: "Ethics/Leadership/Communication 1", category: "breadth", credits: 3, status: "planned", semester: "" },
        { name: "Ethics/Leadership/Communication 2", category: "breadth", credits: 3, status: "planned", semester: "" },
        // 600-Level - counted from above
        { name: "Additional 600-level", category: "600level", credits: 3, status: "planned", semester: "" },
        // Seminar - 3 semesters
        { name: "DSE 599 (Fall 2025)", category: "seminar", credits: 1, status: "in-progress", semester: "Fall 2025" },
        { name: "DSE 599 (Spring 2026)", category: "seminar", credits: 1, status: "planned", semester: "Spring 2026" },
        { name: "DSE 599 (Fall 2026)", category: "seminar", credits: 1, status: "planned", semester: "Fall 2026" }
      ],
      deadlines: [
        { name: "Fall 2025 Classes End", date: "2025-12-05" },
        { name: "Spring 2026 Registration", date: "2026-01-10" },
        { name: "Qualifying Exam", date: "2026-09-15" },
        { name: "Annual Review", date: "2026-04-01" },
        { name: "Proposal Defense", date: "2027-03-01" },
        { name: "Final Defense", date: "2029-04-15" }
      ],
      milestones: [
        { name: "First Semester Complete", completed: false },
        { name: "Committee Formed", completed: false },
        { name: "Qualifying Exam Passed", completed: false },
        { name: "Proposal Defended", completed: false },
        { name: "Dissertation Research", completed: false },
        { name: "Final Defense", completed: false }
      ]
    };

    let ghConfig = JSON.parse(localStorage.getItem('bryan-phd-gh')) || null;
    let fileSha = null;
    let data = JSON.parse(localStorage.getItem('bryan-phd-data')) || defaultData;

    // Tab switching
    function showTab(tabId) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
      document.querySelector(`[onclick="showTab('${tabId}')"]`).classList.add('active');
      document.getElementById('tab-' + tabId).classList.add('active');
    }

    function toggleCategory(id) {
      document.getElementById('cat-' + id).classList.toggle('collapsed');
    }

    // Rendering
    function render() {
      renderHeader();
      renderCourseCategories();
      renderOverview();
      renderDeadlines();
      renderMilestones();
    }

    function renderHeader() {
      const s = data.settings;
      const start = new Date(s.startDate);
      const end = new Date(s.endDate);
      const today = new Date();
      const pct = Math.min(100, Math.max(0, ((today - start) / (end - start)) * 100));

      document.getElementById('timeline-bar').style.width = pct + '%';
      document.getElementById('timeline-text').textContent = pct.toFixed(0) + '% complete';

      // Calculate credits
      const completed = data.courses.filter(c => c.status === 'completed').reduce((s, c) => s + c.credits, 0);
      const transferred = data.courses.filter(c => c.status === 'transfer').reduce((s, c) => s + c.credits, 0);
      const inProgress = data.courses.filter(c => c.status === 'in-progress').reduce((s, c) => s + c.credits, 0);
      const total = completed + transferred;
      const remaining = Math.max(0, s.creditsRequired - total - inProgress);

      document.getElementById('credits-stat').textContent = `${total}/${s.creditsRequired}`;
      document.getElementById('transferred-stat').textContent = transferred;
      document.getElementById('in-progress-stat').textContent = inProgress;
      document.getElementById('remaining-stat').textContent = remaining;

      document.getElementById('sum-transferred').textContent = transferred;
      document.getElementById('sum-completed').textContent = completed;
      document.getElementById('sum-inprogress').textContent = inProgress;
      document.getElementById('sum-remaining').textContent = remaining;

      // Next deadline
      const upcoming = data.deadlines
        .map(d => ({ ...d, days: Math.ceil((new Date(d.date) - today) / 86400000) }))
        .filter(d => d.days >= 0)
        .sort((a, b) => a.days - b.days);
      document.getElementById('next-deadline-stat').textContent = upcoming.length ? upcoming[0].days : '--';
    }

    function renderCourseCategories() {
      const container = document.getElementById('course-categories');
      container.innerHTML = data.courseCategories.map(cat => {
        const courses = data.courses.filter(c => c.category === cat.id);
        const completed = courses.filter(c => c.status === 'completed' || c.status === 'transfer').reduce((s, c) => s + c.credits, 0);
        const inProg = courses.filter(c => c.status === 'in-progress').reduce((s, c) => s + c.credits, 0);

        return `
          <div class="category" id="cat-${cat.id}">
            <div class="category-header" onclick="toggleCategory('${cat.id}')">
              <span class="category-title"><span class="arrow">▼</span> ${cat.name}</span>
              <span class="category-credits">${completed}${inProg ? '+' + inProg : ''}/${cat.requiredCredits} cr</span>
            </div>
            <div class="category-courses">
              ${courses.map((c, i) => {
                const idx = data.courses.indexOf(c);
                const isCompleted = c.status === 'completed' || c.status === 'transfer';
                return `
                  <div class="course-row ${isCompleted ? 'completed' : ''}">
                    <input type="checkbox" ${isCompleted ? 'checked' : ''} onchange="toggleCourseStatus(${idx})">
                    <span class="course-title">${c.name}</span>
                    <div class="course-meta">
                      ${c.status === 'in-progress' ? '<span class="badge in-progress">IN PROGRESS</span>' : ''}
                      ${c.status === 'transfer' ? '<span class="badge transfer">TRANSFER</span>' : ''}
                      ${c.status === 'planned' && c.semester ? `<span class="badge planned">${c.semester}</span>` : ''}
                      <span class="credits">${c.credits}cr</span>
                      <button class="delete-btn" onclick="deleteCourse(${idx})">×</button>
                    </div>
                  </div>
                `;
              }).join('')}
            </div>
          </div>
        `;
      }).join('');
    }

    function renderOverview() {
      // Current semester courses
      const current = data.courses.filter(c => c.status === 'in-progress');
      document.getElementById('current-courses').innerHTML = current.length
        ? current.map(c => `
            <div class="course-row">
              <span class="course-title">${c.name}</span>
              <span class="credits">${c.credits}cr</span>
            </div>
          `).join('')
        : '<div style="color: var(--muted); padding: 1rem; text-align: center;">No courses in progress</div>';

      // Upcoming deadlines (top 4)
      const today = new Date();
      const upcoming = data.deadlines
        .map(d => ({ ...d, days: Math.ceil((new Date(d.date) - today) / 86400000) }))
        .filter(d => d.days >= 0)
        .sort((a, b) => a.days - b.days)
        .slice(0, 4);

      document.getElementById('upcoming-deadlines').innerHTML = upcoming.length
        ? upcoming.map(d => renderDeadlineItem(d)).join('')
        : '<div style="color: var(--muted); padding: 1rem; text-align: center;">No upcoming deadlines</div>';

      // Milestones
      document.getElementById('overview-milestones').innerHTML = data.milestones.map((m, i) => `
        <div class="milestone-item" onclick="toggleMilestone(${i})">
          <div class="milestone-check ${m.completed ? 'done' : ''}">${m.completed ? '✓' : ''}</div>
          <span>${m.name}</span>
        </div>
      `).join('');
    }

    function renderDeadlineItem(d) {
      const urgency = d.days <= 14 ? 'red' : d.days <= 30 ? 'yellow' : 'green';
      let remaining = d.days + 'd';
      if (d.days > 365) remaining = (d.days / 365).toFixed(1) + 'yr';
      else if (d.days > 60) remaining = (d.days / 30).toFixed(1) + 'mo';
      const dateStr = new Date(d.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
      const idx = data.deadlines.findIndex(x => x.name === d.name && x.date === d.date);

      return `
        <div class="deadline-item">
          <div class="urgency ${urgency}"></div>
          <div class="deadline-info">
            <div class="deadline-name">${d.name}</div>
            <div class="deadline-date">${dateStr}</div>
          </div>
          <div class="deadline-remaining">${remaining}</div>
          <button class="delete-btn" onclick="deleteDeadline(${idx})">×</button>
        </div>
      `;
    }

    function renderDeadlines() {
      const today = new Date();
      const sorted = data.deadlines
        .map(d => ({ ...d, days: Math.ceil((new Date(d.date) - today) / 86400000) }))
        .sort((a, b) => a.days - b.days);

      document.getElementById('all-deadlines').innerHTML = sorted.length
        ? sorted.map(d => renderDeadlineItem(d)).join('')
        : '<div style="color: var(--muted); padding: 1rem; text-align: center;">No deadlines</div>';
    }

    function renderMilestones() {
      document.getElementById('all-milestones').innerHTML = data.milestones.map((m, i) => `
        <div class="milestone-item" onclick="toggleMilestone(${i})">
          <div class="milestone-check ${m.completed ? 'done' : ''}">${m.completed ? '✓' : ''}</div>
          <span>${m.name}</span>
          <button class="delete-btn" onclick="event.stopPropagation(); deleteMilestone(${i})">×</button>
        </div>
      `).join('');
    }

    // CRUD
    function toggleCourseStatus(i) {
      const c = data.courses[i];
      if (c.status === 'completed' || c.status === 'transfer') {
        c.status = 'planned';
      } else {
        c.status = 'completed';
      }
      save();
    }

    function openModal(type) {
      document.getElementById('modal-' + type).classList.add('active');
      if (type === 'settings') {
        document.getElementById('settings-start').value = data.settings.startDate;
        document.getElementById('settings-end').value = data.settings.endDate;
        document.getElementById('settings-credits').value = data.settings.creditsRequired;
      }
      if (type === 'github' && ghConfig) {
        document.getElementById('gh-username').value = ghConfig.username;
        document.getElementById('gh-repo').value = ghConfig.repo;
        document.getElementById('gh-token').value = ghConfig.token;
        document.getElementById('gh-disconnect').style.display = 'block';
      }
    }

    function closeModal(type) {
      document.getElementById('modal-' + type).classList.remove('active');
    }

    function saveCourse() {
      const name = document.getElementById('course-name').value.trim();
      const category = document.getElementById('course-category').value;
      const credits = parseInt(document.getElementById('course-credits').value);
      const status = document.getElementById('course-status').value;
      const semester = document.getElementById('course-semester').value.trim();
      if (!name) return alert('Enter course name');
      data.courses.push({ name, category, credits, status, semester });
      save();
      closeModal('course');
      document.getElementById('course-name').value = '';
      document.getElementById('course-semester').value = '';
    }

    function saveDeadline() {
      const name = document.getElementById('deadline-name').value.trim();
      const date = document.getElementById('deadline-date').value;
      if (!name || !date) return alert('Fill all fields');
      data.deadlines.push({ name, date });
      save();
      closeModal('deadline');
      document.getElementById('deadline-name').value = '';
      document.getElementById('deadline-date').value = '';
    }

    function saveMilestone() {
      const name = document.getElementById('milestone-name').value.trim();
      if (!name) return alert('Enter milestone name');
      data.milestones.push({ name, completed: false });
      save();
      closeModal('milestone');
      document.getElementById('milestone-name').value = '';
    }

    function saveSettings() {
      data.settings.startDate = document.getElementById('settings-start').value;
      data.settings.endDate = document.getElementById('settings-end').value;
      data.settings.creditsRequired = parseInt(document.getElementById('settings-credits').value);
      save();
      closeModal('settings');
    }

    function deleteCourse(i) { data.courses.splice(i, 1); save(); }
    function deleteDeadline(i) { data.deadlines.splice(i, 1); save(); }
    function deleteMilestone(i) { data.milestones.splice(i, 1); save(); }
    function toggleMilestone(i) { data.milestones[i].completed = !data.milestones[i].completed; save(); }

    // Save & Sync
    async function save() {
      localStorage.setItem('bryan-phd-data', JSON.stringify(data));
      render();
      if (ghConfig) await syncToGitHub();
    }

    function updateSyncStatus(status, text) {
      document.getElementById('sync-dot').className = 'sync-dot ' + status;
      document.getElementById('sync-text').textContent = text;
    }

    async function syncToGitHub() {
      if (!ghConfig) return;
      updateSyncStatus('syncing', 'Syncing...');
      try {
        const { username, repo, token } = ghConfig;
        const apiUrl = `https://api.github.com/repos/${username}/${repo}/contents/data.json`;
        const getRes = await fetch(apiUrl, { headers: { 'Authorization': `token ${token}` } });
        if (getRes.ok) fileSha = (await getRes.json()).sha;
        const content = btoa(unescape(encodeURIComponent(JSON.stringify(data, null, 2))));
        const body = { message: `Update - ${new Date().toLocaleString()}`, content, branch: 'main' };
        if (fileSha) body.sha = fileSha;
        const putRes = await fetch(apiUrl, {
          method: 'PUT',
          headers: { 'Authorization': `token ${token}`, 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });
        if (putRes.ok) {
          fileSha = (await putRes.json()).content.sha;
          updateSyncStatus('connected', 'Synced');
        } else throw new Error();
      } catch (e) {
        updateSyncStatus('error', 'Sync failed');
      }
    }

    async function loadFromGitHub() {
      if (!ghConfig) return false;
      try {
        const { username, repo, token } = ghConfig;
        const res = await fetch(`https://api.github.com/repos/${username}/${repo}/contents/data.json`, {
          headers: { 'Authorization': `token ${token}` }
        });
        if (res.ok) {
          const fileData = await res.json();
          fileSha = fileData.sha;
          data = JSON.parse(decodeURIComponent(escape(atob(fileData.content))));
          localStorage.setItem('bryan-phd-data', JSON.stringify(data));
          return true;
        }
      } catch (e) {}
      return false;
    }

    async function connectGitHub() {
      const username = document.getElementById('gh-username').value.trim();
      const repo = document.getElementById('gh-repo').value.trim();
      const token = document.getElementById('gh-token').value.trim();
      if (!username || !repo || !token) return alert('Fill all fields');
      updateSyncStatus('syncing', 'Connecting...');
      try {
        const res = await fetch(`https://api.github.com/repos/${username}/${repo}`, {
          headers: { 'Authorization': `token ${token}` }
        });
        if (!res.ok) throw new Error();
        ghConfig = { username, repo, token };
        localStorage.setItem('bryan-phd-gh', JSON.stringify(ghConfig));
        if (await loadFromGitHub()) render();
        else await syncToGitHub();
        closeModal('github');
        updateSyncStatus('connected', 'Connected');
      } catch (e) {
        alert('Failed to connect');
        updateSyncStatus('error', 'Failed');
      }
    }

    function disconnectGitHub() {
      ghConfig = null;
      fileSha = null;
      localStorage.removeItem('bryan-phd-gh');
      updateSyncStatus('', 'Local only');
      closeModal('github');
    }

    function exportData() {
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'phd-tracker.json';
      a.click();
    }

    function importData(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = e => {
        try {
          data = JSON.parse(e.target.result);
          save();
        } catch (err) {
          alert('Invalid JSON');
        }
      };
      reader.readAsText(file);
    }

    document.querySelectorAll('.modal').forEach(m => {
      m.addEventListener('click', e => { if (e.target === m) m.classList.remove('active'); });
    });

    async function init() {
      if (ghConfig) {
        updateSyncStatus('syncing', 'Loading...');
        if (await loadFromGitHub()) updateSyncStatus('connected', 'Connected');
        else updateSyncStatus('connected', 'Connected');
      }
      render();
    }

    init();
  </script>
</body>
</html>
